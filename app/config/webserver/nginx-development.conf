# Nginx Configuration for Riya Collections - Development Environment
# This configuration is optimized for local development

server {
    listen 80;
    listen [::]:80;
    server_name localhost riya-collections.local;
    root /path/to/riya-collections/public;
    index index.php index.html;
    
    # Development logging - Verbose
    access_log /var/log/nginx/riya-collections-dev-access.log;
    error_log /var/log/nginx/riya-collections-dev-error.log debug;
    
    # Development client settings - Generous limits
    client_max_body_size 50M;
    client_body_timeout 120s;
    client_header_timeout 120s;
    
    # Development CORS - Allow all origins
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, X-Request-ID" always;
    add_header Access-Control-Allow-Credentials "true" always;
    
    # Development caching - Disabled
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
    
    # Handle preflight requests
    location ~* \.(OPTIONS)$ {
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH";
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With";
        add_header Access-Control-Max-Age 86400;
        return 200;
    }
    
    # API routes - Route to PHP
    location ^~ /api/ {
        try_files $uri $uri/ /index.php?$query_string;
        
        # Development API headers
        add_header X-Debug-Mode "development" always;
        add_header X-API-Version "1.0.0-dev" always;
    }
    
    # Static assets - Serve directly with no caching
    location ~* \.(css|js|png|jpg|jpeg|gif|svg|webp|woff|woff2|ttf|otf|eot|ico|pdf)$ {
        try_files $uri =404;
        
        # Development - No caching
        expires off;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        
        # Allow CORS for assets
        add_header Access-Control-Allow-Origin "*";
    }
    
    # Uploads directory
    location ^~ /uploads/ {
        try_files $uri =404;
        
        # Development - Allow all file types for testing
        location ~* \.(php|php3|php4|php5|phtml|pl|py|jsp|asp|sh|cgi)$ {
            return 403;
        }
    }
    
    # PHP processing
    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
        
        # Development PHP settings
        fastcgi_param PHP_VALUE "
            error_reporting=E_ALL
            display_errors=On
            display_startup_errors=On
            memory_limit=512M
            max_execution_time=120
            upload_max_filesize=50M
            post_max_size=50M
            max_file_uploads=20
        ";
        
        # Development timeouts - Generous
        fastcgi_read_timeout 300;
        fastcgi_connect_timeout 300;
        fastcgi_send_timeout 300;
    }
    
    # Frontend SPA routes - Serve index.php for client-side routing
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }
    
    # Development security - Minimal restrictions
    location ~ /\. {
        deny all;
    }
    
    location ~* \.(env|log|sql|md|txt|json|lock|yml|yaml|xml|ini|conf)$ {
        deny all;
    }
    
    # Development directories - Block access
    location ~* ^/(app|storage|database|tests|deployment|vendor)/ {
        deny all;
    }
    
    # Development error pages
    error_page 404 /index.php;
    error_page 500 502 503 504 /index.php;
}

# Development SSL configuration (optional)
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name localhost riya-collections.local;
    root /path/to/riya-collections/public;
    index index.php index.html;
    
    # Development SSL certificates (self-signed)
    ssl_certificate /path/to/ssl/localhost.crt;
    ssl_certificate_key /path/to/ssl/localhost.key;
    
    # Development SSL settings - Less strict
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    
    # Include all HTTP configuration
    include /path/to/this/config/nginx-development-common.conf;
}

# Development upstream for PHP-FPM
upstream php-fpm-dev {
    server unix:/var/run/php/php7.4-fpm.sock;
}

# Development rate limiting - Disabled
# limit_req_zone $binary_remote_addr zone=dev:10m rate=1000r/s;

# Development gzip - Disabled for faster debugging
# gzip off;