# Apache Configuration for Riya Collections - Production Environment
# This configuration is optimized for production security and performance

<VirtualHost *:80>
    ServerName riyacollections.com
    ServerAlias www.riyacollections.com
    
    # Redirect all HTTP traffic to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>

<VirtualHost *:443>
    ServerName riyacollections.com
    ServerAlias www.riyacollections.com
    DocumentRoot /var/www/riyacollections/public
    
    # Production logging - Minimal but effective
    LogLevel warn
    ErrorLog ${APACHE_LOG_DIR}/riyacollections-error.log
    CustomLog ${APACHE_LOG_DIR}/riyacollections-access.log combined
    
    # SSL Configuration - Production grade
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/riyacollections.com.crt
    SSLCertificateKeyFile /etc/ssl/private/riyacollections.com.key
    SSLCertificateChainFile /etc/ssl/certs/riyacollections.com-chain.crt
    
    # Modern SSL configuration
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder on
    SSLCompression off
    SSLSessionTickets off
    
    # OCSP Stapling
    SSLUseStapling on
    SSLStaplingResponderTimeout 5
    SSLStaplingReturnResponderErrors off
    
    # Document root configuration
    <Directory /var/www/riyacollections/public>
        Options -Indexes -Includes -ExecCGI
        AllowOverride All
        Require all granted
        
        # Security headers
        Header always set X-Content-Type-Options nosniff
        Header always set X-Frame-Options DENY
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
        Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        
        # Content Security Policy
        Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://checkout.razorpay.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://api.razorpay.com; frame-src https://api.razorpay.com; object-src 'none'; base-uri 'self'; form-action 'self';"
        
        # Remove server information
        Header unset Server
        Header unset X-Powered-By
        ServerTokens Prod
    </Directory>
    
    # Protect sensitive files and directories
    <FilesMatch "\.(env|log|sql|md|txt|json|lock|yml|yaml|xml|ini|conf|bak|backup|old|tmp)$">
        Require all denied
    </FilesMatch>
    
    <DirectoryMatch "^/var/www/riyacollections/(app|storage|database|tests|deployment|vendor)">
        Require all denied
    </DirectoryMatch>
    
    # Asset caching - Aggressive for production
    <LocationMatch "\.(css|js|png|jpg|jpeg|gif|svg|webp|woff|woff2|ttf|otf|eot|ico)$">
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
        Header set Cache-Control "public, max-age=31536000, immutable"
        
        # Add ETag for cache validation
        FileETag MTime Size
    </LocationMatch>
    
    # API CORS - Restricted to production domains
    <LocationMatch "^/api/">
        Header always set Access-Control-Allow-Origin "https://riyacollections.com"
        Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
        Header always set Access-Control-Allow-Credentials "true"
        Header always set Access-Control-Max-Age "86400"
        
        # Handle preflight requests
        RewriteCond %{REQUEST_METHOD} OPTIONS
        RewriteRule ^(.*)$ $1 [R=200,L]
    </LocationMatch>
    
    # Compression - Maximum efficiency
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/plain
        AddOutputFilterByType DEFLATE text/html
        AddOutputFilterByType DEFLATE text/xml
        AddOutputFilterByType DEFLATE text/css
        AddOutputFilterByType DEFLATE text/javascript
        AddOutputFilterByType DEFLATE application/xml
        AddOutputFilterByType DEFLATE application/xhtml+xml
        AddOutputFilterByType DEFLATE application/rss+xml
        AddOutputFilterByType DEFLATE application/javascript
        AddOutputFilterByType DEFLATE application/x-javascript
        AddOutputFilterByType DEFLATE application/json
        AddOutputFilterByType DEFLATE image/svg+xml
        
        # Don't compress images, videos, or already compressed files
        SetEnvIfNoCase Request_URI \
            \.(?:gif|jpe?g|png|webp|mp4|mov|avi|zip|gz|bz2)$ no-gzip dont-vary
        SetEnvIfNoCase Request_URI \
            \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
    </IfModule>
    
    # Production PHP settings
    <IfModule mod_php7.c>
        php_admin_flag display_errors Off
        php_admin_flag display_startup_errors Off
        php_admin_value error_reporting "E_ERROR | E_WARNING | E_PARSE"
        php_admin_flag log_errors On
        php_admin_value memory_limit "256M"
        php_admin_value max_execution_time "30"
        php_admin_value upload_max_filesize "5M"
        php_admin_value post_max_size "5M"
        php_admin_value max_file_uploads "10"
        php_admin_flag expose_php Off
        php_admin_flag allow_url_fopen Off
        php_admin_flag allow_url_include Off
    </IfModule>
    
    # Production rewrite rules
    RewriteEngine On
    
    # Security: Block suspicious requests
    RewriteCond %{QUERY_STRING} (<|%3C).*script.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} ^.*(\[|\]|\(|\)|<|>|Ãª|"|;|\?|\*|=$).* [NC,OR]
    RewriteCond %{QUERY_STRING} ^.*("|'|<|>|\|{|\}).* [NC,OR]
    RewriteCond %{QUERY_STRING} ^.*(%0|%A|%B|%C|%D|%E|%F|127\.0).* [NC]
    RewriteRule .* - [F,L]
    
    # Block suspicious user agents
    RewriteCond %{HTTP_USER_AGENT} ^$ [OR]
    RewriteCond %{HTTP_USER_AGENT} ^(java|curl|wget) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} (winhttp|HTTrack|clshttp|archiver|loader|email|harvest|extract|grab|miner) [NC]
    RewriteRule .* - [F,L]
    
    # API routes
    RewriteCond %{REQUEST_URI} ^/api/
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(.*)$ /index.php [QSA,L]
    
    # Static assets - serve directly if they exist
    RewriteCond %{REQUEST_FILENAME} -f
    RewriteRule \.(css|js|png|jpg|jpeg|gif|svg|webp|woff|woff2|ttf|otf|eot|ico|pdf)$ - [L]
    
    # Uploads directory
    RewriteCond %{REQUEST_URI} ^/uploads/
    RewriteCond %{REQUEST_FILENAME} -f
    RewriteRule ^(.*)$ - [L]
    
    # Frontend SPA routes
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} !^/api/
    RewriteRule ^(.*)$ /index.php [QSA,L]
    
    # Rate limiting (if mod_evasive is available)
    <IfModule mod_evasive24.c>
        DOSHashTableSize    2048
        DOSPageCount        10
        DOSSiteCount        50
        DOSPageInterval     1
        DOSSiteInterval     1
        DOSBlockingPeriod   600
        DOSLogDir           /var/log/apache2/evasive
        DOSEmailNotify      admin@riyacollections.com
    </IfModule>
    
    # Custom error pages
    ErrorDocument 400 /index.php
    ErrorDocument 401 /index.php
    ErrorDocument 403 /index.php
    ErrorDocument 404 /index.php
    ErrorDocument 500 /index.php
    ErrorDocument 503 /index.php
    
    # File upload security
    <Directory /var/www/riyacollections/public/uploads>
        # Prevent execution of PHP files in uploads
        <FilesMatch "\.php$">
            Require all denied
        </FilesMatch>
        
        # Only allow specific file types
        <FilesMatch "\.(jpg|jpeg|png|webp|gif|pdf)$">
            Require all granted
        </FilesMatch>
        
        # Deny everything else
        <FilesMatch "^(?!.*\.(jpg|jpeg|png|webp|gif|pdf)$).*$">
            Require all denied
        </FilesMatch>
    </Directory>
</VirtualHost>

# Global production security settings
<IfModule mod_security2.c>
    SecRuleEngine On
    SecRequestBodyAccess On
    SecResponseBodyAccess Off
    SecRequestBodyLimit 10485760
    SecRequestBodyNoFilesLimit 131072
    SecRequestBodyInMemoryLimit 131072
    SecRequestBodyLimitAction Reject
    SecPcreMatchLimit 1000
    SecPcreMatchLimitRecursion 1000
</IfModule>

# Hide Apache version
ServerTokens Prod
ServerSignature Off